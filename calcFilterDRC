#!/bin/bash

# Get command line parameters
DRC_CFG_FILE="$1"
IMPULSE_FILE="$2"
FILTER_FILE="$3"
NUM_CHANNELS="$4"
RATE="44100"
# defaults
TMP="/tmp"
SOX="sox"

filename=$(basename "$IMPULSE_FILE")
extension="${filename##*.}"
echo "extension : " $extension
if [ "$extension" == "wav" ]; then
 #get number of chanels from the wavefile
 #TODO : test on german installation  whether those matches are language independent 
 read NUM_CHANNELS <<< $(soxi "${IMPULSE_FILE}" | awk '/Channels/ { print $3 }')
 read RATE <<< $(soxi "${IMPULSE_FILE}" | awk '/Sample Rate/ { print $4 }')
else
 #convert to wave to have a common format to start from
 echo "detected raw file input : doing sox conversion"
 DEST_WAV="/tmp/TmpWave.wav"
 #cleanup previous temp file if exists
 rm $DEST_WAV -f
 echo "destination wave file : " $DEST_WAV
 sox -t raw -r $RATE -c $NUM_CHANNELS -e float -b32 ${IMPULSE_FILE} -t wav -r $RATE -e float -b32 ${DEST_WAV}
 IMPULSE_FILE="$DEST_WAV"
 echo "IMPULSE_FILE : " $IMPULSE_FILE
fi

#loop over NUM_CHANNELS and create a filter for each channel
for ((i=1;i<=NUM_CHANNELS;i++));
do
    PCM_IMP_FILENAME=${TMP}/impulse_chanel$i.pcm
    if [ $i == 1 ]; then
        #default for left channel
        REMIX_PARAM="remix 1 0"
        if [ $NUM_CHANNELS == 1 ]; then
            REMIX_PARAM=""
        fi
        #left channel
        $SOX $IMPULSE_FILE -t raw -r $RATE -e float -b 32 -c 1 $PCM_IMP_FILENAME $REMIX_PARAM
    elif [ $i == 2 ]; then
        #right channel
        $SOX $IMPULSE_FILE -t raw -r $RATE -e float -b 32 -c 1 $PCM_IMP_FILENAME remix 0 1
    else
        echo "mhhh multi chanel not properly supported for more than 2 channels yet feel free to add :)"    
    fi
    echo DRCCfgFile : $DRC_CFG_FILE
    echo "calculating filters"
    PCM_FILTER=${TMP}/filter$i.pcm
    drc --BCInFile=$PCM_IMP_FILENAME --PSOutFile=$PCM_FILTER --TCOutFile=test.pcm "${DRC_CFG_FILE}"
    WAV_FILTER=${TMP}/filter$i.wav
     sox -t raw -r $RATE -c 1 -e float -b32 ${PCM_FILTER} -t wav -r $RATE -e float -b32 ${WAV_FILTER}
    PCM_FILTERS[i]=$WAV_FILTER
done

#merge all filters into one wave
echo "merging all filters : " ${PCM_FILTERS[1]} ${PCM_FILTERS[2]} ${FILTER_FILE}
sox -M ${PCM_FILTERS[1]} ${PCM_FILTERS[2]} ${FILTER_FILE}

