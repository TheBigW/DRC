#!/bin/bash

# Get command line parameters

PORC="${1}"
TARGET_CURVE_FILE="${2}"
IMPULSE_FILE="${3}"
FILTER_FILE="${4}"
NUM_CHANNELS="${5}"
RATE="44100"
TAPS=4096

filename=$(basename "$IMPULSE_FILE")
extension="${filename##*.}"
echo "extension : " $extension
if [ "$extension" != "wav" ]; then
  echo "detected raw file input : doing sox conversion"
  DEST_WAV="/tmp/TmpWave.wav"
  #cleanup previous temp file if exists
  rm $DEST_WAV -f
  echo "destination wave file : " $DEST_WAV
  sox -t raw -r $RATE -c 1 -e float -b32 ${IMPULSE_FILE} -t wav -r $RATE -e float -b32 ${DEST_WAV}
  IMPULSE_FILE="$DEST_WAV"
  echo "IMPULSE_FILE : " $IMPULSE_FILE
else
 #get number of chanels from the wavefile
 #TODO : test on german installation  whether those matches are language independent 
 read NUM_CHANNELS <<< $(soxi "${IMPULSE_FILE}" | awk '/Channels/ { print $3 }')
 read RATE <<< $(soxi "${IMPULSE_FILE}" | awk '/Sample Rate/ { print $4 }')
fi

#going with flat target curve. param -t allows for target curve. e.g -t tact30f.txt
#filter length 65535 : same as DRC
echo "removing leading silence for mixed-min phase mode"
REM_SILENCE_IMP_FILE=/tmp/rem_silence_imp.wav
sox $IMPULSE_FILE $REM_SILENCE_IMP_FILE silence 1 0.003 0.005%

echo "calculating filters"

PCM_FILTER=/tmp/PORC_TMP_Filter.pcm

python $PORC --mixed  -n $TAPS -o bin -t "${TARGET_CURVE_FILE}" $REM_SILENCE_IMP_FILE $PCM_FILTER

#convert result to wav


sox -t raw -r $RATE -c 2 -e float -b32 ${PCM_FILTER} -t wav -r $RATE -e float -b32 $FILTER_FILE
