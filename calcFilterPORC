#!/bin/bash

# Get command line parameters

PORC="${1}"
PORC_PARAMS="${2}"
TARGET_CURVE_FILE="${3}"
IMPULSE_FILE="${4}"
FILTER_FILE="${5}"
CURR_CHANNEL="${6}"

TAPS=4096
RATE="44100"


filename=$(basename "$IMPULSE_FILE")
extension="${filename##*.}"
echo "extension : " $extension
if [ "$extension" != "wav" ]; then
  echo "detected raw file input : doing sox conversion"
  DEST_WAV="/tmp/TmpWave.wav"
  #cleanup previous temp file if exists
  rm $DEST_WAV -f
  echo "destination wave file : " $DEST_WAV
  sox -t raw -r $RATE -c 1 -e float -b32 ${IMPULSE_FILE} -t wav ${DEST_WAV}
  IMPULSE_FILE="$DEST_WAV"
  echo "IMPULSE_FILE : " $IMPULSE_FILE
else
 echo "nothing to do: already got wave file"
fi

#filter length 65535 : same as DRC
echo "calculating filters"

PCM_FILTER=/tmp/PORC_TMP_Filter.pcm

python $PORC $PORC_PARAMS -n $TAPS -o bin -t "${TARGET_CURVE_FILE}" $IMPULSE_FILE $PCM_FILTER

#convert result to wav
sox -t raw -r $RATE -c 2 -e float -b32 ${PCM_FILTER} -t wav $FILTER_FILE
