#!/bin/bash
BIT_DEPTH=32
SAMPLE_RATE=44100
SILENCE_LENGTH=2
TMP="/tmp"

AMPLITUDE="$1"
INPUT_HW="$2"
OUTPUT_HW="$3"
START_FREQ="$4"
END_FREQ="$5"
DURATION="$6"
IMP_OUT_FILE="$7"
REC_CHANNEL="$8"
SEPARATE_CHANNEL="$9"
NUM_CHANNELS="${10}"
PLUGIN_PATH=`dirname $0`

$ECHO "Temporary file cleanup of previous measurment..."
$RM ${TMP}/*.pcm
$RM ${TMP}/*.wav


messurescript=${PLUGIN_PATH}"/measure"
echo "\n\n executing" $messurescript $BIT_DEPTH $SAMPLE_RATE $START_FREQ $END_FREQ $DURATION $SILENCE_LENGTH $INPUT_HW $OUTPUT_HW ${IMP_OUT_FILE} $AMPLITUDE $REC_CHANNEL $SEPARATE_CHANNEL $NUM_CHANNELS"\n\n"

if [ "$SEPARATE_CHANNEL" == "False" ]; then
    bash $messurescript $BIT_DEPTH $SAMPLE_RATE $START_FREQ $END_FREQ $DURATION $SILENCE_LENGTH $INPUT_HW $OUTPUT_HW $IMP_OUT_FILE $AMPLITUDE $REC_CHANNEL $NUM_CHANNELS
else
	#TODO loop over NUM_CHANNELS, execute measurement and build IMP_RESULT_FILES string
	IMP_RESULT_FILES=""
	for ((i=0;i<NUM_CHANNELS;i++));
	do
		CURRENT_FILE="imp_"$i".wav"
		IMP_RESULT_FILES="$IMP_RESULT_FILES $CURRENT_FILE"
		bash $messurescript $BIT_DEPTH $SAMPLE_RATE $START_FREQ $END_FREQ $DURATION $SILENCE_LENGTH $INPUT_HW $OUTPUT_HW $CURRENT_FILE $AMPLITUDE $REC_CHANNEL $NUM_CHANNELS $i
	done
	
    #combine all outputs to one file with sox
    sox -M $IMP_RESULT_FILES ${IMP_OUT_FILE}
fi
